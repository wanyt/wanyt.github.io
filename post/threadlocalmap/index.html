<html>
<head>
    <meta charset="utf-8"/>
<meta name="description" content=""/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>ThreadLocalMap | Yt100</title>

<link rel="shortcut icon" href="https://wanyt.github.io/favicon.ico?v=1597309250387">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://wanyt.github.io/styles/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css">

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dart.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script>
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->



    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <nav class="navbar navbar-expand-lg">
    <div class="navbar-brand">
        <img class="user-avatar" src="/images/avatar.png" alt="头像">
        <div class="site-name gt-c-content-color-first">
            Yt100
        </div>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
                <div class="nav-item">
                    
                        <a href="/" class="menu gt-a-link">
                            首页
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/archives" class="menu gt-a-link">
                            归档
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/tags" class="menu gt-a-link">
                            标签
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/post/about" class="menu gt-a-link">
                            关于
                        </a>
                    
                </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1597309250387" action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>

    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    ThreadLocalMap
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        · 2020-08-13 ·
                    </time>
                    
                </div>
                <div class="post-content">
                    <blockquote>
<p>线性探测法解决哈希冲突的典型实现</p>
</blockquote>
<p>既然是Map那么它就是用来存储键值对的的数据结构。Java中常用的Map有HashMap、HashTable、ConcurrentHashMap等。ThreadLocalMap并没有实现Map接口，它不属于Java的集合体系，它是包级别可见，没有对开发者开放，仅供ThreadLocal和Thread使用。</p>
<p>HashMap使用拉链法解决哈希冲突；ThreadLocalMap和HashTable一样使用线性探测法解决哈希冲突。</p>
<p>为什么使用WeakReference?</p>
<pre><code class="language-java">private void set(ThreadLocal&lt;?&gt; key, Object value) {
	Entry[] tab = table;
	int len = tab.length;
	int i = key.threadLocalHashCode &amp; (len-1);

	for (Entry e = tab[i];
		 e != null; // 如果e有值，则进入循环；如果e为null，则退出循环
		 e = tab[i = nextIndex(i, len)]) { // 循环体执行完成后，执行本语句；执行本语句的前提是：i-1有值
		ThreadLocal&lt;?&gt; k = e.get();

		if (k == key) { // 找到了相同的key，则新值覆盖旧值，然后返回
			e.value = value;
			return;
		}

		if (k == null) { // Entry不为空，但key为null，代表key已被GC回收
			replaceStaleEntry(key, value, i);
			return;
		}
	}

	// 执行到此代表哈希后的数组索引处没有Entry，可直接将key-value存储至该索引处
	tab[i] = new Entry(key, value);
	int sz = ++size; // 容量+1
	if (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold) 
		// 如果数组中不需要清除已被回收的元素，并且容量已达扩容的阈值，则对数组进行扩容
		rehash();
}
</code></pre>
<pre><code class="language-java">private void replaceStaleEntry(ThreadLocal&lt;?&gt; key, Object value,int staleSlot) {
	Entry[] tab = table;
	int len = tab.length;
	Entry e;

	int slotToExpunge = staleSlot;
	//从staleSlot开始向上遍历
	for (int i = prevIndex(staleSlot, len); //获取当前位置的前一个位置作为初始索引
		 (e = tab[i]) != null; // 如果entry有值，进入循环体，如果为null则退出循环
		 i = prevIndex(i, len)) // 获取前一个索引的值
		if (e.get() == null) // 循环体，如果Entry不为null且key为null，则代表key已被GC回收，该索引处的Entry可被销毁
			slotToExpunge = i; //记录可以被销毁的索引

	//从staleSlot开始向下遍历
	for (int i = nextIndex(staleSlot, len); //获取当前位置的下一个索引作为初始值
		(e = tab[i]) != null; //如果entry有值，进入循环体，如果为null则退出循环
		i = nextIndex(i, len)) { //获取下一个索引
		ThreadLocal&lt;?&gt; k = e.get();

		if (k == key) { //如果索引处的Entry.key和方法参数中的key相等
			e.value = value;//新值覆盖旧值

			tab[i] = tab[staleSlot];  //!!!!!!!此处代码意图还不是太明晰!!!!!!!
			tab[staleSlot] = e;

			if (slotToExpunge == staleSlot)
				slotToExpunge = i;
			cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);
			return;
		}

		if (k == null &amp;&amp; slotToExpunge == staleSlot)
			slotToExpunge = i;
	}

	tab[staleSlot].value = null; //标记旧的Entry可被GC回收
	tab[staleSlot] = new Entry(key, value); //记录新的Entry

	if (slotToExpunge != staleSlot) 
	// 如果slotToExpunge和staleSlot的值不相等，则代表哈希表中有需要被销毁的Entry，此时需要做清理Entry的操作
		cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);
}

</code></pre>
<pre><code class="language-java">private boolean cleanSomeSlots(int i, int n) {
	boolean removed = false; // 是否有被移除的Entry
	Entry[] tab = table;
	int len = tab.length;
	// 先执行do，然后执行while，满足条件再执行do；如此往复
	do {
		i = nextIndex(i, len); //获取下一个索引
		Entry e = tab[i]; //获取下一个索引处的Entry
		if (e != null &amp;&amp; e.get() == null) { // 如果Entry不为null,但key为null,则该Entry可被销毁
			n = len; // 控制遍历次数
			removed = true; 
			i = expungeStaleEntry(i); //删除该处索引的Entry

		}
	} while ( (n &gt;&gt;&gt;= 1) != 0); //每次n右移1位则等同于n除以2，！！为什么这样做有待考证！！
	return removed; 
}
</code></pre>
<ul>
<li>i：一个已知的可用的Entry索引，从i+1处开始扫描</li>
</ul>
<pre><code class="language-java">private int expungeStaleEntry(int staleSlot) {
	Entry[] tab = table;
	int len = tab.length;

	tab[staleSlot].value = null;
	tab[staleSlot] = null; //把索引处的Entry置为null
	size--; // size减1

	// 从staleSlot+1开始向下遍历, 
	// 如果发现有Entry.key为null, 则将该Entry置为null
	// 如果Entry不为null, 则使用哈希值对其重新映射
	Entry e;
	int i;
	for (i = nextIndex(staleSlot, len); // 从staleSlot+1开始
		 (e = tab[i]) != null;  // Entry有值进入循环, 否则退出循环
		 i = nextIndex(i, len)) { // 获取下一个索引, 向下遍历
		ThreadLocal&lt;?&gt; k = e.get();
		if (k == null) { // 如果key为null将Entry置为null
			e.value = null;
			tab[i] = null;
			size--;
		} else { // 如果key不为null, 对Entry rehash
			int h = k.threadLocalHashCode &amp; (len - 1);
			if (h != i) {
				tab[i] = null;

				while (tab[h] != null)
					h = nextIndex(h, len); // 线性探测解决哈希冲突
				tab[h] = e;
			}
		}
	}
	return i;
}

</code></pre>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">下一篇</div>
                <a href="https://wanyt.github.io/post/xuan-ze-pai-xu/" class="post-title gt-a-link">
                    选择排序
                </a>
            </div>
        

        

        

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first">实践出真知</div>
    <div class="social-container">
        
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
    </div>
    <div>
        Theme by <a href="https://imhanjie.com/" target="_blank">imhanjie</a>, Powered by <a
                href="https://github.com/getgridea/gridea" target="_blank">Gridea | <a href="https://wanyt.github.io/atom.xml" target="_blank">RSS</a></a>
    </div>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>

    </div>
</div>
</body>
</html>
